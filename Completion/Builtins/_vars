#compdef getopts read unset vared

# This will handle completion of keys of associative arrays, e.g. at
# `vared foo[<TAB>'.  However, in this version the [ must be added
# by hand.

if [[ $PREFIX = *\[* ]]; then
  local var=${PREFIX%%\[*}
  local elt="${PREFIX#*\]}${SUFFIX%\]}"
  local addclose

  compset -p $(( ${#var} + 1 ))
  if ! compset -S \]; then
    addclose=(-S ']')
  fi
  if [[ ${(tP)var} = assoc* ]]; then
    local expl

    _wanted -C subscript association-keys expl 'association key' \
        compadd $addclose - ${(kP)var}
  fi
else
  _parameters
fi
